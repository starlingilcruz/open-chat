{% extends 'base.html' %}

{% block title %}{{ conversation.name }} - Open Chat{% endblock %}

{% block extra_css %}
<style>
    .chat-container { display: flex; flex-direction: column; height: calc(100vh - 200px); background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .chat-header { padding: 20px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
    .message { max-width: 70%; padding: 12px 16px; border-radius: 15px; word-wrap: break-word; }
    .message-own { align-self: flex-end; background: #3498db; color: white; }
    .message-other { align-self: flex-start; background: #ecf0f1; color: #2c3e50; }
    .message-sender { font-size: 12px; font-weight: 600; margin-bottom: 4px; }
    .message-content { font-size: 14px; }
    .chat-input { display: flex; gap: 10px; padding: 20px; border-top: 1px solid #ddd; }
    .chat-input input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 25px; outline: none; }
    .chat-input button { padding: 12px 30px; }
    .participants { display: flex; gap: 10px; align-items: center; }
    .add-participant-btn { padding: 8px 15px; font-size: 14px; }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="chat-header">
        <div>
            <h2 style="margin-bottom: 5px;">{{ conversation.name }}</h2>
            <p style="color: #7f8c8d; font-size: 14px;">
                Participants:
                {% for participant in conversation.participants.all %}
                    {{ participant.user.username }}{% if not forloop.last %}, {% endif %}
                {% endfor %}
            </p>
        </div>
        <div class="participants">
            {% if is_admin %}
            <button onclick="showAddParticipantModal()" class="btn add-participant-btn">+ Add Participant</button>
            {% endif %}
            <a href="{% url 'conversation-list' %}" class="btn add-participant-btn">Back to Conversations</a>
        </div>
    </div>

    <div class="chat-messages" id="messages">
        <!-- Messages will be loaded here -->
    </div>

    <div class="chat-input">
        <input type="text" id="messageInput" placeholder="Type a message..." autocomplete="off">
        <button class="btn" onclick="sendMessage()">Send</button>
    </div>
</div>

<!-- Add Participant Modal -->
{% if is_admin %}
<div id="addParticipantModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="max-width: 500px; margin: 100px auto; background: white; padding: 30px; border-radius: 10px;">
        <h3 style="margin-bottom: 20px;">Add Participant</h3>
        <form id="addParticipantForm" style="display: flex; flex-direction: column; gap: 15px;">
            {% csrf_token %}
            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">User Email</label>
                <input type="email" id="userEmail" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" placeholder="user@example.com">
                <small style="color: #666;">Enter the email address of the user to add</small>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button type="submit" class="btn btn-success" style="flex: 1;">Add</button>
                <button type="button" onclick="hideAddParticipantModal()" class="btn" style="flex: 1; background: #95a5a6;">Cancel</button>
            </div>
        </form>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    const conversationId = '{{ conversation.id }}';
    const currentUserId = {{ user.id }};
    let socket = null;

    // Connect to WebSocket
    function connectWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/conversations/${conversationId}/`;

        socket = new WebSocket(wsUrl);

        socket.onopen = function(e) {
            console.log('WebSocket connected');
            loadMessageHistory();
        };

        socket.onmessage = function(event) {
            const data = JSON.parse(event.data);

            if (data.type === 'message') {
                displayMessage(data.message);
            } else if (data.type === 'error') {
                alert('Error: ' + data.message);
            }
        };

        socket.onclose = function(event) {
            console.log('WebSocket closed. Reconnecting...');
            setTimeout(connectWebSocket, 3000);
        };

        socket.onerror = function(error) {
            console.error('WebSocket error:', error);
        };
    }

    // Load message history
    function loadMessageHistory() {
        fetch(`/api/v1/conversations/${conversationId}/messages`, {
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            const messagesContainer = document.getElementById('messages');
            messagesContainer.innerHTML = '';
            const messages = data.messages || data.results || [];
            messages.forEach(msg => displayMessage(msg));
            scrollToBottom();
        })
        .catch(error => console.error('Error loading messages:', error));
    }

    // Display a message
    function displayMessage(message) {
        const messagesContainer = document.getElementById('messages');
        const messageDiv = document.createElement('div');
        const isOwn = message.user_id === currentUserId;

        messageDiv.className = `message ${isOwn ? 'message-own' : 'message-other'}`;
        messageDiv.innerHTML = `
            ${!isOwn ? `<div class="message-sender">${message.username}</div>` : ''}
            <div class="message-content">${escapeHtml(message.content)}</div>
        `;

        messagesContainer.appendChild(messageDiv);
        scrollToBottom();
    }

    // Send a message
    function sendMessage() {
        const input = document.getElementById('messageInput');
        const content = input.value.trim();

        if (content && socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({
                type: 'message.send',
                content: content
            }));
            input.value = '';
        }
    }

    // Handle Enter key
    document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    // Add participant
    {% if is_admin %}
    document.getElementById('addParticipantForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const userEmail = document.getElementById('userEmail').value;

        fetch(`/api/v1/conversations/${conversationId}/add_participant/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'include',
            body: JSON.stringify({ email: userEmail })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Participant added successfully!');
                hideAddParticipantModal();
                location.reload();
            } else if (data.error) {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to add participant');
        });
    });

    function showAddParticipantModal() {
        document.getElementById('addParticipantModal').style.display = 'block';
    }

    function hideAddParticipantModal() {
        document.getElementById('addParticipantModal').style.display = 'none';
    }
    {% endif %}

    // Utility functions
    function scrollToBottom() {
        const messagesContainer = document.getElementById('messages');
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Initialize WebSocket connection
    connectWebSocket();
</script>
{% endblock %}
