name: open-chat CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  setup:
    uses: ./.github/workflows/setup.yml
    with:
      python_version: '3.9'
      install_dev_dependencies: true

  lint:
    uses: ./.github/workflows/lint.yml
    needs: setup

  test:
    uses: ./.github/workflows/test.yml
    needs: [setup, lint]
    with:
      python_version: '3.9'
      upload_coverage: true

  deploy:
    name: Deploy to AWS Elastic Beanstalk
    runs-on: ubuntu-latest
    needs: [setup, lint, test]
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install EB CLI
        run: |
          python -m pip install --upgrade pip
          pip install awsebcli

      - name: Configure AWS credentials
        run: |
          mkdir -p ~/.aws
          echo "[default]" > ~/.aws/credentials
          echo "aws_access_key_id = ${{ secrets.AWS_ACCESS_KEY_ID }}" >> ~/.aws/credentials
          echo "aws_secret_access_key = ${{ secrets.AWS_SECRET_ACCESS_KEY }}" >> ~/.aws/credentials
          echo "[default]" > ~/.aws/config
          echo "region = ${{ secrets.AWS_REGION }}" >> ~/.aws/config

      - name: Deploy to EB
        run: |
          eb init ${{ secrets.EB_APPLICATION_NAME }} \
            --platform python-3.11 \
            --region ${{ secrets.AWS_REGION }}
          eb use ${{ secrets.EB_ENVIRONMENT_NAME }}
          eb deploy --verbose

      - name: Check deployment status
        if: success()
        run: |
          echo "âœ… Deployment successful!"
          echo "Environment: ${{ secrets.EB_ENVIRONMENT_NAME }}"
          eb status
